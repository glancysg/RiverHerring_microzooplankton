---
title: "microzoo_analysis"
author: "Sarah Glancy"
date: "3/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

#Overview of steps to this projects data compiling and analysis. 
#1- add data to github- this includes the fish growth data, microzoo counts, ambient environment data and larval gut data (gut data not generated as of 2021-05-06)

```{r}

library(readxl)

bin_counts <- read_excel("C:/Users/Sarah/Desktop/WHOI/Microzooplankton/binCounts_20210506.xlsx")
View(bin_counts)

library(readr)

# Otolith_Growth_Rate_4DO <- read_csv("C:/Users/Sarah/Desktop/WHOI/Microzooplankton/Otolith_Growth_Rate_4DO.csv")

Otolith_Growth_Rate_All <- read_csv("C:/Users/Sarah/Desktop/WHOI/Microzooplankton/Otolith_Growth_Rate_all.csv")

```

## load in older files supplied by Justin (will not be chnaged) from google drive. 

#DC lesson on sheet management/organization
#https://datacarpentry.org/spreadsheet-ecology-lesson/

```{r}
library(tidyverse)
library(googlesheets4)
library(googledrive)

# Google Sheet is the input
myurl <- "https://docs.google.com/spreadsheets/d/1EJuErt2DDZDtzXWHWAbuwS9ptBaA1lkPDLeeiBQg-KU/edit?usp=sharing" # url for googlesheet
gs4_auth() # manual authorization thru web browser
Fish_collection_date_relate <- read_sheet(myurl) # manual authorization thru web browser


gs4_get(Fish_collection_date_relate)

```

##before joining tables, change date to day of year, prepresented in #lubridate function as %j. Is 1 = Jan 1st etc. 

##try to change to year-month-day with simple function, will it work with 6 digit date?
```{r}
library(lubridate)
#ymd(150520)
```

##Yes!!

## now need to change all dates in 4 pages to this format. 
## alternative, can I go from 6 digit date directly to year-day?
     

#Use libridate function yday() 

```{r}
 # yday(Fish_collection_date_relate$Date)
```
  ##does not seem to work directly.
  
```{r}

ymd(Fish_collection_date_relate$Date)
```
  # that worked (but i hid it becasue it was huge), now use mutate() to add a column with this new date information to the end of the df. 
  
```{r}
#Fish_collection_ymd_date <- mutate(Fish_collection_date_relate, 
#       ymd_date = ymd(Fish_collection_date_relate$Date))
```
  ##yay, worked again, now change to year-day
  
```{r}

 #transmute(Fish_collection_ymd_date, 
 #         year_day = yday(ymd_date))
```
  Yay again!
  
  ## Question: do joins though tidyverse require the joining column to have the same column name? I guess yes, should I just change the column name to match before attempting?
  
```{r}
#Fish_collection_3.0 <- Fish_collection_ymd_date %>%
#  rename( Fish_Num = Oto_Num) %>% 
#  mutate( year_day = yday(Fish_collection_ymd_date$ymd_date))
  

```
  
## That worked!!
## need to figure out how to save a change to my df without renaming (ie creating ## a bunch of dfs) it every time? 

-----------------------------------------------

##Attempting a join now that the col namesa re the same. full join. 

```{r}
#Fish_Otolith_Join <- full_join(Fish_collection_3.0, Otolith_Growth_Rate_all, by = "Fish_Num")

```

##Okay next step is to get dates with the current bin counts from EP. 

```{r}
Date_bin_relational <- read_excel("C:/Users/Sarah/Desktop/WHOI/Microzooplankton/Date_bin_relational.xlsx")

Date_bin_relational <- rename(Date_bin_relational, bin = IFCB_ID)

#Dated_bin_EP <- full_join(Date_bin_relational, bin_counts, by = "bin")

```

##the join did not appear to work, some of them that shoud match are not. 

try using other join types. want to keep all info from the bin_counts file, so try Ljoin with that one listed first? what is difference between l and r join if the order of dfs can be switched?


```{r}
#LJ_bincounts_Dates <- left_join(bin_counts, Date_bin_relational, by = "bin")
```

~~~~~~~~~~~~~~~~~~
above blocked out because it was using a xlsx and i've since switched to .csv. 

##Now working on the bins with microzoo counts to make them able to join, and also abole to join the fish data (will be LAKE_DATE (date in year_day))

change date to year_day and create column with lake and date united to join with fish data.  


```{r}

Date_bin <- Date_bin_relational%>%
  mutate ( year_day = yday(ymd(Date))) %>%
  unite("Lake_ID", Lake, year_day, remove = FALSE)

view(Date_bin)

```


## that all seems to have worked. 

#The same LakeID should match to multiple fishes. There will be multiples in the Lake ID from the Date_bin df because 3 samples were run on each sample jar. they need to be summed.

can I use group by to sum all the volume data about the bins?

```{r}
Grouped_Date_bin <- Date_bin %>%
  group_by(Lake_ID) %>%
  summarise(Vol_Img_L = sum(Vol_Img_L), Num_ROIs = sum(Num_ROIs))


view(Grouped_Date_bin)
```

#SO this kind of worked, but I think I shoudl add in the counts and then use summarize with them as well to creatre a df, than join in the data with a left or right join to fill  in the missing data. 

```{r}
EP_Summary <- read.csv("C:/Users/Sarah/Desktop/WHOI/Microzooplankton/RiverHerring_microzooplankton/summary_EP_05062021.csv")

view(EP_Summary)

```

loaded in correctly. now full join with date bin, should be no NA rows!

```{r}

#Date_bin <- Date_bin %>%
#  rename( bin = "IFCB_ID")

EP_Summary <- EP_Summary %>%
  rename( bin = "X")

view(Date_bin)
view(EP_Summary)

#Join_date_micro_counts <- full_join(EP_Summary, Date_bin, by = "bin")
Microzoo <- full_join(EP_Summary, Date_bin, by = "bin")

#view(Join_date_micro_counts)

```

## Yes! that worked perfectly, with 108 rows. 

## now run again the grouped summarise function. 

```{r}
#Summed_Counts <- Join_date_micro_counts %>%
#  group_by(Lake_ID) %>%
#  summarise(Vol_Img_L = sum(Vol_Img_L), Num_ROIs = sum(Num_ROIs), Nauplii = sum(Nauplii), Karatella = sum(Karatella), Polyarthra = sum(Polyarthra), Asplanchna = sum(Asplanchna), Tricocera = sum(Tricocera), Mallomonas = sum(Mallomonas))

#view(Summed_Counts)

Summed_Microzoo <- Microzoo %>%
  group_by(Lake_ID) %>%
  summarise(Vol_Img_L = sum(Vol_Img_L), Num_ROIs = sum(Num_ROIs), Nauplii = sum(Nauplii), Karatella = sum(Karatella), Polyarthra = sum(Polyarthra), Asplanchna = sum(Asplanchna), Tricocera = sum(Tricocera), Mallomonas = sum(Mallomonas))

```


## had idea to used another column inaddition to Lake_ID which is the lake and year-day that the fish was sampled, and also include an identifier which is Lake_ID_age chich would be the year-day date minus the age in days of the fish.

##then filter by the ages (right now named day, should rename) that have dates that match zoop sampling daye

## point is to get fish of a certain age that have matching zoop data. 

```{r}

Fish_half_noNA <- Fish_half_noNA %>% 
  rename( age_day = "Day")

Fish_half_noNA <- Fish_half_noNA %>% 
  mutate( back_age_day = year_day) %>% # day of the year that the fish was that day
  unite("back_Lake_ID", Lake, back_age_day)

view(Fish_half_noNA)




```


#accidentally removed the columns united, but not fatal error.

#use filter to make a list of fish that had a ring measured on days 3-6. 

```{r}
Small_fish_half <- Fish_half_noNA %>%
  filter(between(age_day, 3, 7))

view( Small_fish_half)
```


```{r}
# aggregate and then merge 
Fish_age <- aggregate(Day ~ Fish_Num, data = Otolith_Growth_Rate_All, FUN = max)

head(Fish_age)

Fish_age <- Fish_age %>%
  rename( Collect_age = "Day")

CMH_Fish_Dating <- merge(Fish_age, Otolith_Growth_Rate_All, all.y= TRUE)

view(CMH_Fish_Dating)

#CMH_Fish_Dating$Back_Lake_ID <- unite(CMH_Fish_Dating$Lake, )
Fish_collection_date_relate <- Fish_collection_date_relate%>%
  rename(Fish_Num = Oto_Num)

CMH_Fish_Dating <- left_join(CMH_Fish_Dating, Fish_collection_date_relate, by = "Fish_Num")

#CMH_Fish_Dating<- CMH_Fish_Dating%>%
#  mutate ( back_year_day = yday(ymd(Date))) %>%
#   unite("back_Lake_ID", Lake, year_day - Collect_age + Day, remove = FALSE)

CMH_Fish_Dating<- CMH_Fish_Dating%>%
  mutate ( back_year_day = year_day - Collect_age + Day) %>%
  unite("back_Lake_ID", Lake, back_year_day, remove = FALSE)

view(CMH_Fish_Dating)


# restrict this object to be only rows with fish ages 3-5, and back year days that match zooplankton collectiON 
# two steps. 
# restrict first to have more manageable set. look up merge()

#CMH_Fish_Dating[,c(“Date”,”Fish_Num”, “back_Lake_ID”)] then ass the other df with the columns desired from that one. 

```

Create a list of column titles I want. 

## Date, Fish_Num, back_Lake_ID, Collect_age, Lake, Day, Temperature, SL, year_day, back_year_day



